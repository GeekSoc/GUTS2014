package org.geeksoc.guts2014;

import java.util.LinkedList;
import java.util.Queue;
import java.util.Random;
import java.util.Timer;
import java.util.TimerTask;

public class JobFactory {

	private static double lambda = 1.0/100.0; // rate in the poisson process

	private static Random random = new Random();
	public static boolean isRunning;
	private boolean addNew = false;
	private static Timer timer = new Timer();

	private Queue<Job> jobQueue = new LinkedList<Job>();
	
	private double randomWait;
	private long randomWait_ms;

	public void update(){
<<<<<<< HEAD
		if (addNew) {
			Job job = new Job();
			jobQueue.add(job);
			addNew=false;
			
			System.out.println(String.format("Job added (%dms) - %s",
					randomWait_ms, job.toString()));
=======
		int speed = GameTime.getSpeed();
		if (speed == 0) {
			stopJobCreation();
		} else {
			if (!isRunning) {
				startJobCreation();
			}
			setLambda(speed / 1000.0);
>>>>>>> 79bfc9bd0f4d32a92a7cdcc6858c4d5c024f0fcb
		}
	}

	public Queue<Job> getJobQueue() {
		return jobQueue;
	}

	public void addInitialJobs(int max) {
		for (int i = 1; i <= max; i++) {
			Job job = new Job();
			jobQueue.add(job);
			System.out.println(String.format("Initial job %d: %s", i,
					job.toString()));
		}
	}

	class Task extends TimerTask {
		@Override
		public void run() {
<<<<<<< HEAD
			randomWait = -Math.log(1.0 - random.nextDouble()) / lambda;
			randomWait_ms = (long) randomWait;
=======
			update();
			
			double randomWait = -Math.log(1.0 - random.nextDouble()) / lambda;
			long randomWait_ms = (long) randomWait;
>>>>>>> 79bfc9bd0f4d32a92a7cdcc6858c4d5c024f0fcb
			timer.schedule(new Task(), randomWait_ms);
			addNew = true;
		}
	}

	public void createJobs() {
		if (isRunning) {
			new Task().run();
		}
	}

	public void startJobCreation() {
		clearJobs();
		isRunning = true;
		createJobs();
	}

	public void stopJobCreation() {
		timer.cancel();
		timer = new Timer();
		clearJobs();
		isRunning = false;
	}

	public void clearJobs() {
		jobQueue.clear();
	}

	public int numJobs() {
		return jobQueue.size();
	}

	public void setLambda(double lmb) {
		lambda = lmb;
	}
}
